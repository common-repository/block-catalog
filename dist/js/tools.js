!function(){"use strict";class e extends EventTarget{load(e){this.progress=0,this.total=0,this.triggerEvent("loadStart");const t={url:e.endpoint,method:"POST",data:{post_types:e.postTypes||[]},...e};return this.apiFetch(t).then((e=>(e.errors||!e.success&&e.data?this.triggerEvent("loadError",e):void 0===e?.posts||0===e?.posts.length?this.triggerEvent("loadError",{code:"invalid_response",message:"Server returned empty posts."}):this.triggerEvent("loadComplete",e),e))).catch((e=>{this.triggerEvent("loadError",e)}))}async index(e,t){this.progress=0,this.completed=0,this.failures=0,this.total=e.length,this.triggerEvent("indexStart",{progress:0,total:this.total});const s=this.toChunks(e,t.batchSize||50),i=s.length;for(let e=0;e<i;e++){const i=s[e];try{await this.indexBatch(i,t)}catch(e){this.failures+=i.length,this.progress+=i.length,this.triggerEvent("indexProgress",{progress:this.progress,total:this.total}),this.triggerEvent("indexError",e)}}this.triggerEvent("indexComplete",{progress:this.progress,total:this.total,completed:this.completed,failures:this.failures})}async indexBatch(e,t={}){const s={url:t.endpoint,method:"POST",data:{post_ids:e},...t},i=this.apiFetch(s);return i.then((t=>{t.errors||!t.success&&t.data?(this.failures+=e.length,this.triggerEvent("indexError",t)):void 0===t?.updated?(this.failures+=e.length,this.triggerEvent("indexError",{code:"invalid_response",message:"Failed to index some posts"})):this.completed+=e.length,this.progress+=e.length,this.triggerEvent("indexProgress",{progress:this.progress,total:this.total,...t})})),i}cancel(){this.cancelPending(),this.triggerEvent("indexCancel",{progress:this.progress,total:this.total})}loadTerms(e){this.progress=0,this.total=0,this.triggerEvent("loadTermsStart");const t={url:e.endpoint,method:"POST",data:{},...e};return this.apiFetch(t).then((e=>(e.errors||!e.success&&e.data?this.triggerEvent("loadTermsError",e):void 0===e?.terms||0===e?.terms.length?this.triggerEvent("loadTermsError",{code:"invalid_response",message:"Server returned empty terms.",...e}):this.triggerEvent("loadTermsComplete",e),e))).catch((e=>{this.triggerEvent("loadTermsError",e)}))}async deleteIndex(e){this.progress=0,this.completed=0,this.failures=0,this.total=0,this.triggerEvent("deleteIndexStart");const t={url:e.endpoint,method:"POST"};return this.apiFetch(t).then((e=>(e.errors||!e.success&&e.data?this.triggerEvent("deleteIndexError",e):this.triggerEvent("deleteIndexComplete",e),e))).catch((e=>{this.triggerEvent("deleteIndexError",e)}))}cancelDelete(){this.cancelPending(),this.triggerEvent("deleteIndexCancel")}triggerEvent(e,t={}){const s=new CustomEvent(e,{detail:t});this.dispatchEvent(s)}toChunks(e,t=50){const s=e.shift(),i=[];for(let s=0;s<e.length;s+=t)i.push(e.slice(s,s+t));return i.unshift([s]),i}cancelPending(){if(this.pending?.length)for(let e=0;e<this.pending.length;e++){this.pending[e].cancelled=!0}this.pending=[]}apiFetch(e){this.pending||(this.pending=[]),this.cancelPending();const t=this.apiFetchWithCancel(e);return this.pending.push(t),t}apiFetchWithCancel(e){const t=wp.apiFetch(e),s=new Promise(((e,i)=>{t.then((t=>{s?.cancelled||e(t)})).catch((e=>{s?.cancelled||i(e)}))}));return s.request=t,s}}var t=e;const{__:s,sprintf:i}=wp.i18n;class d{constructor(e){this.settings=e}enable(){this.indexer=new t,this.state={status:"settings",message:""},this.onIndex("loadStart","didLoadStart"),this.onIndex("loadComplete","didLoadComplete"),this.onIndex("loadError","didLoadError"),this.onIndex("indexStart","didIndexStart"),this.onIndex("indexProgress","didIndexProgress"),this.onIndex("indexComplete","didIndexComplete"),this.onIndex("indexCancel","didIndexCancel"),this.onIndex("indexError","didIndexError"),this.onIndex("deleteIndexStart","didDeleteIndexStart"),this.onIndex("deleteIndexProgress","didDeleteIndexProgress"),this.onIndex("deleteIndexComplete","didDeleteIndexComplete"),this.onIndex("deleteIndexError","didDeleteIndexError"),this.onIndex("deleteIndexCancel","didDeleteIndexCancel"),this.on(".block-catalog-post-type","change","didPostTypesChange"),this.on("#submit","click","didSubmitClick"),this.on("#cancel","click","didCancelClick"),this.on("#delete-index","click","didDeleteIndexClick"),this.on("#cancel-delete","click","didDeleteCancelClick")}setState(e){switch(this.prevState=this.state,this.state=e,e.status){case"loading":case"indexing":case"indexed":this.hide("#index-settings"),this.show("#index-status"),this.updateProgress();break;case"loaded":this.hide("#index-settings"),this.show("#index-status");break;case"load-error":case"settings":case"cancelled":this.show("#index-settings"),this.hide("#index-status");break;case"loading-terms":case"deleting":this.hide("#index-settings"),this.show("#delete-status"),this.updateDeleteProgress();break;case"loaded-terms":this.hide("#index-settings"),this.show("#delete-status");break;case"load-terms-error":case"deleted":case"delete-error":case"delete-cancel":this.show("#index-settings"),this.hide("#delete-status")}this.setMessage(this.state.message||"")}didLoadStart(){const e=s("Loading posts to index ...","block-catalog");this.setState({status:"loading",message:e}),this.hideErrors(),this.setNotice(""),window.scrollTo(0,0)}didLoadComplete(e){const t=s("Loaded posts, starting ...","block-catalog");this.setState({status:"loaded",message:t,...e.detail});const i={batchSize:this.settings?.index_batch_size,endpoint:this.settings?.index_endpoint};this.indexer.index(this.state.posts,i)}didLoadError(e){const t=e.detail||{};let i=s("Failed to load posts to index.","block-catalog");t?.message&&(i+=`  (${t?.code} - ${t.message})`),t?.data?.message?i+=`  (${t.data.message})`:"string"===typeof t?.data&&(i+=`  (${t.data})`),this.setState({status:"load-error",message:"",error:t}),this.setNotice(i,"error")}didIndexStart(e){const t=i(s("Indexing %d / %d Posts ...","block-catalog"),e.detail.progress,e.detail.total);this.setState({status:"indexing",message:t,...e.detail})}didIndexProgress(e){const t=i("Indexing %d / %d Posts ...",e.detail.progress,e.detail.total);this.setState({status:"indexing",message:t,...e.detail})}didIndexComplete(e){let t,d;0===e.detail.failures?(t=i(s('Indexed %d / %d Posts Successfully. <a href="%s">View Block Catalog</a>',"block-catalog"),e.detail.completed,e.detail.total,this.settings.catalog_page),d="success"):e.detail.failures>0&&e.detail.completed>0?(t=i(s('Indexed %d Posts successfully with %d Errors. <a href="%s">View Block Catalog</a>',"block-catalog"),e.detail.completed,e.detail.failures),d="error"):(t=i(s("Failed to index %d Posts.","block-catalog"),e.detail.total),d="error"),this.setState({status:"settings",message:"",...e.detail}),this.setNotice(t,d)}didIndexCancel(e){const t=s("Index cancelled.","block-catalog");this.setState({status:"cancelled",message:"",...e.detail}),this.setNotice(t,"error")}didIndexError(e){const t=e.detail||{};let i=s("Failed to index posts","block-catalog");t?.message&&(i+=`  (${t?.code} - ${t.message})`),t?.data?.message?i+=`  (${t.data.message})`:"string"===typeof t?.data&&(i+=`  (${t.data})`),this.addErrorLine(i),this.updateProgress()}didDeleteIndexStart(e){const t=s("Deleting Index ...","block-catalog");this.setState({status:"deleting",message:t,...e.detail}),window.scrollTo(0,0)}didDeleteIndexProgress(e){const t=i("Deleting %d / %d Block Catalog Terms ...",e.detail.progress,e.detail.total);this.setState({status:"deleting",message:t,...e.detail})}didDeleteIndexComplete(e){let t;e.detail?.failures?(t=i(s("Failed to delete %d catalog term(s).","block-catalog"),e.detail?.failures),this.setNotice(t,"error")):e.detail?.removed?(t=i(s("Deleted %d block catalog term(s) successfully.","block-catalog"),e.detail?.removed),this.setNotice(t,"success")):(t=s("Nothing to delete, block catalog index is empty.","block-catalog"),this.setNotice(t,"error")),this.setState({status:"deleted",message:"",...e.detail})}didDeleteIndexError(e){const t=e.detail||{};let i=s("Failed to delete block catalog terms. ","block-catalog");t?.message&&(i+=`  (${t?.code} - ${t.message})`),t?.data?.message?i+=`  (${t.data.message})`:"string"===typeof t?.data&&(i+=`  (${t.data})`),this.addErrorLine(i)}didDeleteIndexCancel(e){const t=s("Deleting Index Cancelled.","block-catalog");this.setState({status:"delete-cancel",message:"",...e.detail}),this.setNotice(t,"error")}didSubmitClick(){const e={postTypes:this.getSelectedPostTypes(),endpoint:this.settings.posts_endpoint};return this.indexer.load(e),!1}didCancelClick(){return this.indexer.cancel(),!1}didDeleteIndexClick(){const e=s("This will delete all terms in the Block Catalog index. Are you sure?","block-catalog");if(!confirm(e))return!1;const t={endpoint:this.settings.delete_index_endpoint};return this.indexer.deleteIndex(t),!1}didDeleteCancelClick(){return this.indexer.cancelDelete(),!1}didPostTypesChange(){this.updateSubmitButton()}updateSubmitButton(){const e=this.getSelectedPostTypes(),t=document.querySelector("#submit");t&&(t.disabled=0===e.length)}getSelectedPostTypes(){const e=document.querySelectorAll(".block-catalog-post-type:checked");return e?[...e].map((e=>e.value)):[]}on(e,t,s){const i=document.querySelectorAll(e);i&&i.length&&i.forEach((e=>{e.addEventListener(t,this[s].bind(this))}))}onIndex(e,t){this.indexer.addEventListener(e,this[t].bind(this))}show(e){const t=document.querySelector(e);t&&(t.style.display="block")}hide(e){const t=document.querySelector(e);t&&(t.style.display="none")}setMessage(e){const t=document.querySelector("#index-message");t&&(t.style.display=""!==e?"block":"none",t.innerHTML=e)}setNotice(e,t="success"){const s=document.querySelector("#index-notice"),i=document.querySelector("#index-notice-body");s&&(s.style.display=""!==e?"block":"none",s.className=`notice notice-${t}`),i&&(i.innerHTML=e)}updateProgress(){const e=this.indexer.total?this.indexer.progress/this.indexer.total*100:0,t=document.querySelector("#index-progress");t&&(t.value=e)}updateDeleteProgress(){const e=this.indexer.total?this.indexer.progress/this.indexer.total*100:0,t=document.querySelector("#delete-progress");t&&(t.value=e)}hideErrors(){const e=document.querySelector("#index-errors-list");e&&(e.innerHTML="");const t=document.querySelector("#index-errors");t&&(t.style.display="none")}addErrorLine(e){const t=document.querySelector("#index-errors"),s=document.querySelector("#index-errors-list");if(t&&(t.style.display="block"),!s)return;const i=document.createElement("li");i.innerHTML=e,s.appendChild(i)}}document.addEventListener("DOMContentLoaded",(()=>{const e=window.block_catalog?.settings||{};new d(e).enable()}))}();